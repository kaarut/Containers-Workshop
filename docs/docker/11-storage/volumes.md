# Docker Volumes

## Overview

Volumes are the preferred mechanism for persisting data generated by and used by Docker containers. While bind mounts are dependent on the directory structure and OS of the host machine, volumes are completely managed by Docker. Some of the advantages over bind mounts:

- Volumes are easier to back up or migrate than bind mounts.
- You can manage volumes using Docker CLI commands or the Docker API.
- Volumes can be more safely shared among multiple containers.

In addition, volumes are often a better choice than persisting data in a container’s writable layer, because a volume does not increase the size of the containers using it, and the volume’s contents exist outside the lifecycle of a given container.

![Volumes and Types of Mounts](./volume-types-of-mounts.png)

## Create and Manage Volumes

Unlike a bind mount, you can create and manage volumes outside the scope of any container.

- Create a volume:

    ```bash
    docker volume create my-vol
    ```

- List volumes:

    ```bash
    $ docker volume ls

    DRIVER    VOLUME NAME
    local     my-vol
    ```

- Inspect a volume:

    ```bash
    $ docker volume inspect my-vol

    [
        {
            "CreatedAt": "2022-11-25T11:30:47+01:00",
            "Driver": "local",
            "Labels": {},
            "Mountpoint": "/var/lib/docker/volumes/my-vol/_data",
            "Name": "my-vol",
            "Options": {},
            "Scope": "local"
        }
    ]
    ```

- Remove a volume:

    ```bash
    docker volume rm my-vol
    ```

## Start a Container with a Volume

If you start a container with a volume that doesn’t yet exist, Docker creates the volume for you. The following example mounts the volume `myvol2` into `/app/` in the container.

```bash
docker run -d \
  --name cms-daq-volume-test \
  --mount source=myvol2,target=/app \
  nginx:latest
```

Use `docker inspect cms-daq-volume-test` to verify that the volume was created and mounted correctly. Look for the Mounts section:

```bash
$ docker inspect cms-daq-volume-test --format '{{json .Mounts}}'

[
  {
    "Type": "volume",
    "Name": "myvol2",
    "Source": "/var/lib/docker/volumes/myvol2/_data",
    "Destination": "/app",
    "Driver": "local",
    "Mode": "z",
    "RW": true,
    "Propagation": ""
  }
]
```

This shows that the mount is a volume, it shows the correct source and destination, and that the mount is read-write.

Let's create some files in the mount path of the volume (inside the container):

```bash
# Create the files
$ docker exec -it cms-daq-volume-test touch /app/myfile1 /app/myfile2

# List files in the mounted directory of the container
$ docker exec -it cms-daq-volume-test ls -al /app/

total 0
drwxr-xr-x. 2 root root  36 Nov 25 10:53 .
drwxr-xr-x. 1 root root 102 Nov 25 10:52 ..
-rw-r--r--. 1 root root   0 Nov 25 10:53 myfile1
-rw-r--r--. 1 root root   0 Nov 25 10:53 myfile2
```

Stop and remove the container. Note that the volume will still exist after the container deletion.


```bash
$ docker container stop cms-daq-volume-test

$ docker container rm cms-daq-volume-test
```

Confirm that the Docker volume is still present in the system:

```bash
$ docker volume ls

DRIVER    VOLUME NAME
local     myvol2
```

Create a new container and mount the _already existing_ volume:

```bash
$ docker run -d \
    --name cms-daq-volume-test2 \
    --mount source=myvol2,target=/app \
    nginx:latest

73714bf2bcec7ce4e0f65a75dee39ffeaef0a6d013ab0a0de22efc2cd659ada0
```

Confirm that the files created in a previous step are still present in the volume attached to the _new_ container:

```bash
$ docker exec -it cms-daq-volume-test2 ls -al /app/

total 0
drwxr-xr-x. 2 root root 36 Nov 25 10:53 .
drwxr-xr-x. 1 root root 50 Nov 25 11:08 ..
-rw-r--r--. 1 root root  0 Nov 25 10:53 myfile1
-rw-r--r--. 1 root root  0 Nov 25 10:53 myfile2
```

Remove the volume. Note volume removal is a separate step.

```bash
$ docker volume rm myvol2
```
